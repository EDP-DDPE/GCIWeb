{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Lista de Subestações</h2>
        <a href="{{ url_for('subestacoes.nova_subestacao') }}" class="btn btn-success">
            Adicionar Subestação
        </a>
    </div>

    <div class="row">
        <!-- Conteúdo principal (tabela) -->
        <div class="col-md-9">
            <table class="table table-bordered table-hover" id="tabelaSubestacoes">
                <thead class="table-light">
                    <tr>
                        <!--<th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>ID</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="id" data-direction="asc" title="Ordenar por ID">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th> -->
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Nome</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="nome" data-direction="asc" title="Ordenar por Nome">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>SIGLA</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="sigla" data-direction="asc" title="Ordenar por SIGLA">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Município</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="municipio" data-direction="asc" title="Ordenar por Município">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>EDP</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="edp" data-direction="asc" title="Ordenar por EDP">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody id="corpoTabela">
                    {% for sub in subestacoes %}
                    <tr class="linha-subestacao" 
                        data-id="{{ sub.id_subestacao }}"
                        data-nome="{{ sub.nome|lower }}" 
                        data-sigla="{{ sub.sigla|lower }}" 
                        data-municipio="{{ sub.municipio.municipio|lower }}" 
                        data-edp="{{ sub.edp.empresa|lower }}"
                        data-lat="{{ sub.lat | lower }}"
                        data-long="{{ sub.long | lower }}">
                        <!--<td>{{ sub.id_subestacao }}</td> -->
                        <td>{{ sub.nome }}</td>
                        <td>{{ sub.sigla }}</td>
                        <td>{{ sub.municipio.municipio }}</td>
                        <td>{{ sub.edp.empresa }}</td>
                        <td class="text-center">
                            <button class="btn btn-link p-1 text-muted btn-visualizar me-2" data-bs-toggle="modal" data-bs-target="#modalSub{{ sub.id_subestacao }}" title="Visualizar detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="{{ url_for('subestacoes.editar_subestacao', id=sub.id_subestacao) }}" class="btn btn-link p-1 text-muted btn-editar" title="Editar subestação">
                                <i class="fas fa-edit"></i>
                            </a>
                        </td>
                    </tr>

                    <!-- Modal de detalhes da subestação -->
                    <div class="modal fade" id="modalSub{{ sub.id_subestacao }}" tabindex="-1" aria-labelledby="modalLabel{{ sub.id_subestacao }}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabel{{ sub.id_subestacao }}">
                                        Detalhes da Subestação {{ sub.nome }}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Nome:</strong> {{ sub.nome }}</p>
                                    <p><strong>SIGLA:</strong> {{ sub.sigla }} </p>
                                    <p><strong>Município:</strong> {{ sub.municipio.municipio }} </p>
                                    <p><strong>EDP:</strong> {{ sub.edp.empresa }} </p>
                                    <p><strong>Coordenada X (Graus Decimais):</strong> {{ sub.long }} </p>
                                    <p><strong>Coordenada Y (Graus Decimais):</strong> {{ sub.lat }} </p>

                                    <!-- Contêiner do mapa -->
                                    <div id="mapaSub{{ sub.id_subestacao }}" style="height: 300px; border-radius: 10px;"></div>

                                </div>
                                <div class="modal-footer">
                                    <a href="{{ url_for('subestacoes.editar_subestacao', id=sub.id_subestacao) }}" class="btn btn-primary">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </a>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Mensagem quando não há resultados -->
            <div id="nenhumResultado" class="alert alert-info text-center" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                Nenhuma subestação encontrada com os filtros aplicados.
            </div>
        </div>

        <!-- Sidebar de filtros (fixa à direita) -->
        <div class="col-md-3">
            <div class="card shadow-sm p-3 mb-3 bg-white rounded" style="position: sticky; top: 1rem;">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>Filtros
                </h5>
                <div class="d-flex flex-column gap-3">
                    <div class="form-group">
                        <label class="form-label small text-muted">Nome</label>
                        <input type="text" id="filtroNome" class="form-control filtro-campo" placeholder="Digite o nome...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label small text-muted">Sigla</label>
                        <input type="text" id="filtroSigla" class="form-control filtro-campo" placeholder="Digite a sigla...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label small text-muted">Município</label>
                        <input type="text" id="filtroMunicipio" class="form-control filtro-campo" placeholder="Digite o município...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label small text-muted">EDP</label>
                        <input type="text" id="filtroEdp" class="form-control filtro-campo" placeholder="Digite a EDP...">
                    </div>
                    
                    <hr class="my-2">
                    
                    <button type="button" id="limparFiltros" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Limpar Filtros
                    </button>
                    
                    <div id="contadorResultados" class="small text-muted text-center mt-2">
                        {% set total = subestacoes|length %}
                        Total: <span id="totalLinhas">{{ total }}</span> 
                        {% if total == 1 %}subestação{% else %}subestações{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtros = {
        nome: document.getElementById('filtroNome'),
        sigla: document.getElementById('filtroSigla'),
        municipio: document.getElementById('filtroMunicipio'),
        edp: document.getElementById('filtroEdp')
    };
    
    const linhas = document.querySelectorAll('.linha-subestacao');
    const tbody = document.getElementById('corpoTabela');
    const nenhumResultado = document.getElementById('nenhumResultado');
    const limparFiltros = document.getElementById('limparFiltros');

    function normalizeText(text) {
        return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function aplicarFiltros() {
        let linhasVisiveis = 0;
        linhas.forEach(linha => {
            const dados = {
                nome: normalizeText(linha.dataset.nome),
                sigla: normalizeText(linha.dataset.sigla),
                municipio: normalizeText(linha.dataset.municipio),
                edp: normalizeText(linha.dataset.edp)
            };
            let mostrar = true;
            Object.keys(filtros).forEach(campo => {
                const valorFiltro = normalizeText(filtros[campo].value.trim());
                if (valorFiltro && !dados[campo].includes(valorFiltro)) {
                    mostrar = false;
                }
            });
            linha.style.display = mostrar ? '' : 'none';
            if (mostrar) linhasVisiveis++;
        });
        // Corrigir o texto singular/plural
        const textoResultado = linhasVisiveis === 1 ? 'subestação' : 'subestações';
        
        // Atualizar o texto completo do contador
        const contadorDiv = document.getElementById('contadorResultados');
        contadorDiv.innerHTML = `Total: <span id="totalLinhas">${linhasVisiveis}</span> ${textoResultado}`;
        
        nenhumResultado.style.display = linhasVisiveis === 0 ? 'block' : 'none';
    }

    Object.values(filtros).forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(input.timeout);
            input.timeout = setTimeout(() => {
                aplicarFiltros();
                atualizarIndicadorFiltros();
            }, 300);
        });
    });

    limparFiltros.addEventListener('click', () => {
        Object.values(filtros).forEach(i => i.value = '');
        aplicarFiltros();
        atualizarIndicadorFiltros();
    });

    function atualizarIndicadorFiltros() {
        const ativo = Object.values(filtros).some(i => i.value.trim() !== '');
        const titulo = document.querySelector('.card h5');
        titulo.innerHTML = ativo
            ? '<i class="fas fa-filter me-2 text-primary"></i>Filtros <small class="badge bg-primary">Ativo</small>'
            : '<i class="fas fa-filter me-2"></i>Filtros';
    }

    // === Ordenação client-side ===
    const sortButtons = document.querySelectorAll('.btn-sort');
    sortButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const sortKey = this.dataset.sort;
            let direction = this.dataset.direction;
            const linhasArray = Array.from(tbody.querySelectorAll('tr'));
            linhasArray.sort((a, b) => {
                const valA = a.dataset[sortKey] || "";
                const valB = b.dataset[sortKey] || "";
                return direction === "asc"
                    ? valA.localeCompare(valB, 'pt-BR', {numeric: true})
                    : valB.localeCompare(valA, 'pt-BR', {numeric: true});
            });
            this.dataset.direction = direction === "asc" ? "desc" : "asc";
            // Resetar todos ícones
            sortButtons.forEach(b => b.querySelector("i").className = "fas fa-sort");

            // Atualizar ícone do botão clicado
            const icon = this.querySelector("i");
            if (this.dataset.direction === "asc") {
                icon.className = "fas fa-sort-up";
            } else {
                icon.className = "fas fa-sort-down";
            }

            linhasArray.forEach(l => tbody.appendChild(l));
        });
    });

     // ==== INÍCIO: mapa Leaflet nos modais ====
    const modais = document.querySelectorAll('.modal');
    
    modais.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            // Encontra o ID da subestação a partir do ID do modal
            const modalId = this.id;
            const idSubestacao = modalId.replace('modalSub', '');
            
            // Encontra a linha correspondente na tabela
            const linha = document.querySelector(`.linha-subestacao[data-id="${idSubestacao}"]`);
            
            if (!linha) return;
            
            const lat = parseFloat(linha.dataset.long);
            const lng = parseFloat(linha.dataset.lat);
            const mapaDiv = document.getElementById(`mapaSub${idSubestacao}`);
            
            // Remove qualquer mapa existente no contêiner
            if (mapaDiv._map) {
                mapaDiv._map.remove();
            }
            
            // Inicializa novo mapa
            const map = L.map(mapaDiv).setView([lat, lng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`Subestação: ${linha.dataset.nome}`)
                .openPopup();
            
            // Força redimensionamento após um pequeno delay
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            // Armazena referência do mapa no elemento div
            mapaDiv._map = map;
        });
        
        // Limpa o mapa quando o modal é fechado
        modal.addEventListener('hidden.bs.modal', function() {
            const modalId = this.id;
            const idSubestacao = modalId.replace('modalSub', '');
            const mapaDiv = document.getElementById(`mapaSub${idSubestacao}`);
            
            if (mapaDiv && mapaDiv._map) {
                setTimeout(() => {
                    mapaDiv._map.remove();
                    mapaDiv._map = null;
                }, 300);
            }
        });
    });
    // ==== FIM: mapa Leaflet nos modais ====

});
</script>

<style>
.filtro-campo {
    transition: border-color 0.3s ease;
}

.filtro-campo:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.linha-subestacao {
    transition: opacity 0.3s ease;
}

#contadorResultados {
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
}

.badge {
    font-size: 0.6em;
    vertical-align: top;
}

/* Estilo dos botões de ordenação discretos */
.btn-sort {
    border: none !important;
    background: transparent !important;
    color: #adb5bd;
    font-size: 14px;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-sort:hover {
    color: #495057 !important;
    background: transparent !important;
    transform: scale(1.1);
}

.btn-sort:focus {
    box-shadow: none;
    color: #495057;
    text-decoration: none;
}

/* Estilo para colunas ordenáveis */
th.d-flex {
    cursor: pointer;
}

th span {
    font-weight: 600;
}

/* Estilo dos botões de ação mais discretos */
.btn-visualizar,
.btn-editar {
    border: none !important;
    background: transparent !important;
    color: #6c757d;
    font-size: 16px;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-visualizar:hover {
    color: #0d6efd !important;
    background: transparent !important;
    transform: scale(1.1);
}

.btn-editar:hover {
    color: #198754 !important;
    background: transparent !important;
    transform: scale(1.1);
}

.btn-visualizar:focus,
.btn-editar:focus {
    box-shadow: none;
    text-decoration: none;
}

.btn-editar:focus {
    color: #198754;
}

.btn-visualizar:focus {
    color: #0d6efd;
}
</style>
{% endblock %}