{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Lista de Estudos</h2>
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nº Documento</th>
                <th>Projeto</th>
                <th>Empresa</th>
                <th>Município</th>
                <th>Responsável</th>
                <th>Data Criação</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documentos %}
            <tr>
                <td>{{ doc.id }}</td>
                <td>{{ doc.num_doc }}</td>
                <td>{{ doc.nome_projeto }}</td>
                <td>{{ doc.empresa }}</td>
                <td>{{ doc.municipio }}</td>
                <td>{{ doc.criado_por }}</td>
                <td>{{ doc.data_registro }}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="verDetalhes({{ doc.id }})">
                        Detalhes
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para detalhes do documento -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-file-alt me-2"></i>Detalhes do Documento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <!-- Conteúdo carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>

// Função para abrir modal e mostrar loader
function verDetalhes(estudoId) {
    const modalBody = document.getElementById('modalDetalhesBody');
    // Mostrar loader
    modalBody.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;

    // Abrir modal imediatamente
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
    modal.show();

    // Buscar dados do estudo
    fetch(`/api/estudos/${estudoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            // Construir conteúdo do modal
            const detalhesHtml = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-info-circle me-2"></i>Informações Básicas
                            </div>
                            <div class="card-body">
                                <p><strong>Protocolo:</strong> ${data.protocolo}</p>
                                <p><strong>Nº Documento:</strong> ${data.num_doc}</p>
                                <p><strong>Projeto:</strong> ${data.nome_projeto}</p>
                                <p><strong>Descrição:</strong> ${data.descricao || 'N/A'}</p>
                                <p><strong>Cliente:</strong> ${data.empresa?.nome || 'N/A'}</p>
                                <p><strong>CNPJ:</strong> ${data.empresa?.cnpj || 'N/A'}</p>
                                <p><strong>Município:</strong> ${data.municipio?.nome || 'N/A'}</p>
                                <p><strong>Regional:</strong> ${data.regional?.nome || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-cogs me-2"></i>Detalhes Técnicos
                            </div>
                            <div class="card-body">
                                <p><strong>Tipo Viabilidade:</strong> ${data.tipo_pedido?.viabilidade || 'N/A'}</p>
                                <p><strong>Criado por:</strong> ${data.criado_por?.nome || 'N/A'}</p>
                                <p><strong>Responsável Região:</strong> ${data.responsavel_regiao?.usuario?.nome || 'N/A'}</p>
                                <p><strong>Data Registro:</strong> ${data.data_registro || 'N/A'}</p>
                                <p><strong>Latitude:</strong> ${data.latitude_cliente || 'N/A'}</p>
                                <p><strong>Longitude:</strong> ${data.longitude_cliente || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-chart-bar me-2"></i>Demandas
                            </div>
                            <div class="card-body">
                                <p><strong>Demanda FP:</strong> ${data.dem_carga_solicit_fp || 'N/A'}</p>
                                <p><strong>Demanda P:</strong> ${data.dem_carga_solicit_p || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-file-upload me-2"></i>Anexos
                            </div>
                            <div class="card-body">
                                ${data.anexos && data.anexos.length > 0 ? `
                                    <ul class="list-group list-group-flush">
                                        ${data.anexos.map(a => `<li class="list-group-item">${a.nome_arquivo} (${a.tipo_mime})</li>`).join('')}
                                    </ul>
                                ` : '<p>Nenhum anexo.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-history me-2"></i>Status Histórico
                            </div>
                            <div class="card-body">
                                ${data.status_historico && data.status_historico.length > 0 ? `
                                    <ul class="list-group list-group-flush">
                                        ${data.status_historico.map(s => `
                                            <li class="list-group-item">
                                                <strong>${s.status || 'N/A'}</strong> - ${s.data || 'N/A'} - ${s.criado_por || 'N/A'}
                                                ${s.observacao ? `<br><small>${s.observacao}</small>` : ''}
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : '<p>Sem histórico de status.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modalBody.innerHTML = detalhesHtml;
        })
        .catch(error => {
            console.error('Erro:', error);
            modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes do documento</div>`;
        });
}
</script>


{% endblock %}
