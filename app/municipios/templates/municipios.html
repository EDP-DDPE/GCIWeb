{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Lista de Municípios</h2>
    </div>

    <div class="row">
        <div class="col-md-3 order-md-2">
            <div class="card shadow-sm p-3 mb-3 bg-white rounded" style="position: sticky; top: 1rem;">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>Filtros
                </h5>
                <div class="d-flex flex-column gap-3">
                    <div class="form-group">
                        <label class="form-label small text-muted">Município</label>
                        <input type="text" id="filtroMunicipio" class="form-control filtro-campo" placeholder="Digite o Município...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label small text-muted">EDP</label>
                        <input type="text" id="filtroEdp" class="form-control filtro-campo" placeholder="Digite a Empresa...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label small text-muted">Regional</label>
                        <input type="text" id="filtroRegional" class="form-control filtro-campo" placeholder="Digite a Regional...">
                    </div>
                    
                    <hr class="my-2">
                    
                    <button type="button" id="limparFiltros" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Limpar Filtros
                    </button>
                    
                    <div id="contadorResultados" class="small text-muted text-center mt-2">
                        Total: <span id="totalLinhas">{{ total_municipios }}</span> município(s)
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9 order-md-1">
            <table class="table table-bordered table-hover" id="tabelaMunicipios">
                <thead class="table-light">
                    <tr>
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>ID</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="id" data-direction="asc" title="Ordenar por ID">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Município</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="municipio" data-direction="asc" title="Ordenar por Município">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>
                        
                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>EDP</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="edp" data-direction="asc" title="Ordenar por EDP">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>

                        <th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Regional</span>
                                <a href="#" class="btn btn-link p-0 text-muted btn-sort" data-sort="regional" data-direction="asc" title="Ordenar por Regional">
                                    <i class="fas fa-sort"></i>
                                </a>
                            </div>
                        </th>

                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody id="corpoTabela">
                    {% for municipio in municipios %}
                    <tr class="linha-municipio" 
                        data-id="{{ municipio.id_municipio }}"
                        data-municipio="{{ municipio.municipio|lower|trim }}" 
                        data-edp="{{ municipio.edp.empresa|lower|trim }}"
                        data-regional="{{ municipio.regional.regional|lower|trim }}">
                        <td>{{ municipio.id_municipio }}</td>
                        <td>{{ municipio.municipio }}</td>
                        <td>{{ municipio.edp.empresa }}</td>
                        <td>{{ municipio.regional.regional }}</td>
                        <td class="text-center">
                            <button class="btn btn-link p-1 text-muted btn-visualizar me-2" data-bs-toggle="modal" data-bs-target="#modalMun{{ municipio.id_municipio }}" title="Visualizar detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    
                    <div class="modal fade" id="modalMun{{ municipio.id_municipio }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Subestações em {{ municipio.municipio }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    {% if municipio.subestacoes %}
                                        <ul>
                                        {% for se in municipio.subestacoes %}
                                            <li>{{ se.nome }}</li>
                                        {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>Nenhuma subestação encontrada para este município.</p>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% endfor %}
                </tbody>
            </table>
            
            <div id="nenhumResultado" class="alert alert-info text-center" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                Nenhum município encontrado com os filtros aplicados.
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo dos botões de ordenação discretos */
.btn-sort {
    border: none !important;
    background: transparent !important;
    color: #adb5bd;
    font-size: 14px;
    transition: all 0.2s ease;
    text-decoration: none;
    font-weight: normal;
}

.btn-sort:hover {
    color: #495057 !important;
    background: transparent !important;
    transform: scale(1.1);
}

.btn-sort:focus {
    box-shadow: none;
    text-decoration: none;
    color: #495057;
}

/* Novo estilo para o container do cabeçalho */
th .d-flex span {
    font-weight: 600; /* Negrito para o texto do cabeçalho */
}

/* Estilo dos botões de ação mais discretos */
.btn-visualizar {
    border: none !important;
    background: transparent !important;
    color: #6c757d;
    font-size: 16px;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-visualizar:hover {
    color: #0d6efd !important;
    transform: scale(1.1);
}

.btn-visualizar:focus {
    box-shadow: none;
    text-decoration: none;
    color: #0d6efd;
}

/* Outros estilos */
.filtro-campo {
    transition: border-color 0.3s ease;
}

.filtro-campo:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.linha-municipio {
    transition: opacity 0.3s ease;
}

#contadorResultados {
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
}

.badge {
    font-size: 0.6em;
    vertical-align: top;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtros = {
        municipio: document.getElementById('filtroMunicipio'),
        edp: document.getElementById('filtroEdp'),
        regional: document.getElementById('filtroRegional')
    };
    
    const linhas = Array.from(document.querySelectorAll('.linha-municipio'));
    const nenhumResultado = document.getElementById('nenhumResultado');
    const totalLinhas = document.getElementById('totalLinhas');
    const limparFiltrosBtn = document.getElementById('limparFiltros');
    const sortButtons = document.querySelectorAll('.btn-sort');

    // Função para normalizar texto (remover acentos)
    function normalizeText(text) {
        if (text) {
            return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        }
        return '';
    }

    // Função para aplicar filtros
    function aplicarFiltros() {
        let linhasVisiveis = 0;
        const valoresFiltros = {
            municipio: normalizeText(filtros.municipio.value),
            edp: normalizeText(filtros.edp.value),
            regional: normalizeText(filtros.regional.value)
        };
        
        linhas.forEach(linha => {
            const dados = {
                municipio: normalizeText(linha.dataset.municipio),
                edp: normalizeText(linha.dataset.edp),
                regional: normalizeText(linha.dataset.regional)
            };
            
            let mostrarLinha = true;
            
            if (valoresFiltros.municipio && !dados.municipio.includes(valoresFiltros.municipio)) {
                mostrarLinha = false;
            }
            if (valoresFiltros.edp && !dados.edp.includes(valoresFiltros.edp)) {
                mostrarLinha = false;
            }
            if (valoresFiltros.regional && !dados.regional.includes(valoresFiltros.regional)) {
                mostrarLinha = false;
            }
            
            if (mostrarLinha) {
                linha.style.display = '';
                linhasVisiveis++;
            } else {
                linha.style.display = 'none';
            }
        });
        
        nenhumResultado.style.display = (linhasVisiveis === 0) ? 'block' : 'none';
    }

    // Aplica a filtragem ao digitar
    Object.values(filtros).forEach(input => {
        input.addEventListener('input', aplicarFiltros);
    });

    // Botão limpar filtros
    limparFiltrosBtn.addEventListener('click', function() {
        Object.values(filtros).forEach(input => {
            input.value = '';
        });
        aplicarFiltros();
    });

    // Função para ordenar a tabela
    function sortTable(columnIndex, direction) {
        const tbody = document.getElementById('corpoTabela');
        const rows = Array.from(tbody.rows);
        const sortedRows = rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();

            if (columnIndex === 0) { // Coluna de ID
                aValue = parseInt(aValue);
                bValue = parseInt(bValue);
            } else { // Outras colunas (string)
                aValue = normalizeText(aValue);
                bValue = normalizeText(bValue);
            }

            if (aValue < bValue) {
                return direction === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });

        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }

        sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Eventos para os botões de ordenação
    sortButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const sort = this.dataset.sort;
            let direction = this.dataset.direction;

            let columnIndex;
            if (sort === 'id') columnIndex = 0;
            else if (sort === 'municipio') columnIndex = 1;
            else if (sort === 'edp') columnIndex = 2;
            else if (sort === 'regional') columnIndex = 3;

            // Remove ícones de ordenação de todos os botões
            sortButtons.forEach(btn => {
                btn.querySelector('i').className = 'fas fa-sort';
            });

            // Atualiza o ícone do botão clicado e a direção
            const icon = this.querySelector('i');
            if (direction === 'asc') {
                icon.className = 'fas fa-sort-up';
                this.dataset.direction = 'desc';
            } else {
                icon.className = 'fas fa-sort-down';
                this.dataset.direction = 'asc';
            }

            sortTable(columnIndex, direction);
        });
    });
});
</script>

{% endblock %}